<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8">
    <title>D3 Page Template</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script> <!-- v6.5.0 -->
</head>
<body>
  <video id="gurenge-video" onplay="playVideo()" onpause="pauseTransition()" onended="makeSubtitles()" controls loop>
      <source src="video/gurenge.mp4" type="video/mp4">
  </video>
  <div id="subtitles"></div>	
</body>

<script type="text/javascript">
  // Your beautiful D3 code will go here
  var subtitleArr = [];
  var width = 900;
  var height = 600;
  var video = document.getElementById("gurenge-video");

  video.onseeking = function() {
      resetSubtitleAnimation()
  };

  d3.select("#gurenge-video")
    .attr("width", width)
    .attr("height", 450)

  d3.select("body")
  	.append("svg")
    .attr("id", "display-area")
  	.attr("width", width)
  	.attr("height", height)

  d3.select("#display-area")
    .append("text")
    .text("Lab09 SVG字幕")
    .attr("class", "title")
    .attr("x", "50%")
    .attr("y", 30)
    .attr("text-anchor", "middle")

  d3.select("#display-area")
    .append("text")
    .text("Gurenge(紅蓮華) - Piano arrangement by Animenz")
    .attr("class", "title")
    .attr("x", "50%")
    .attr("y", 120)
    .attr("text-anchor", "middle")

  var playCount = 0;

  function resetSubtitleAnimation() {
    var currentTime = video.currentTime;

    d3.selectAll(".subtitle")
        .attr("opacity", 0)
        .transition()
        .delay(function(d){
          return (d.start - d.duration / 2 - currentTime) * 1000;
        })
        .duration(function(d){
          return (d.duration + d.duration / 2) * 1000;
        })
        .attr('opacity', 1)
        .transition()
        .duration(function(d){
          return 0;
        })
        .attr('opacity', 0)
  }
  
  function playVideo() {
    playCount += 1;

    if (playCount == 1) {
      makeSubtitles()
    }

    else {
      resetSubtitleAnimation()
    }
  }

  function pauseTransition() {
    d3.selectAll(".subtitle")
      .interrupt()
  }

  function makeSubtitles(){
    d3.csv("gurenge_lyrics_jap.csv", function(data){
      subtitleArr.push({});
      d3.select("#subtitles")
        .selectAll("p")
        .data(data)
        .enter()
        .append("p")
        .text(function(d, i){
          var startTimeMin = parseFloat(d.start.split(":")[0]);
          var startTimeSec = parseFloat(d.start.split(":")[1]);
          var startTime = startTimeMin*60 + startTimeSec;

          var endTimeMin = parseFloat(d.end.split(":")[0]);
          var endTimeSec = parseFloat(d.end.split(":")[1]);
          var endTime = endTimeMin*60 + endTimeSec;

          var subtitle = {
            "start": startTime,
            "end": endTime,
            "duration": endTime - startTime,
            "content": d.subtitle
          };

          subtitleArr.push(subtitle);

        });

      var subtitleSvg = d3.select("body")
        .append("svg")
        .attr("id", "subtitle-svg")
        .attr("width", width)
        .attr("height", 50)
        .attr("transform", "translate(0,"+ 150 + " )")

      subtitleSvg.selectAll("text")
        .data(subtitleArr)
        .enter()
        .append("text")
        .text(function(d){
          return d.content;
        })
        .attr("class", "subtitle")
        .attr("start", function(d){
          return d.start;
        })
        .attr("end", function(d){
          return d.end;
        })
        .attr("duration", function(d){
          return d.duration;
        })
        .attr("x", width / 2)
        .attr("y", 30)
        .attr("text-anchor", "middle")
        .attr("opacity", 0)
        .transition()
        .delay(function(d){
          return (d.start - d.duration / 2) * 1000;
        })
        .duration(function(d){
          return (d.duration + d.duration / 2) * 1000;
        })
        .attr("opacity", 1)
        .transition()
        .duration(function(d){
          return (d.duration / 6.0 * 1000.0);
        })
        .attr("opacity", 0)

    });
  }
</script>
</html>
  